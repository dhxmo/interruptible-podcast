var OggOpusEncoder=function(e,t){if(!t)throw new Error("Module with exports required to initialize an encoder instance");this.config=Object.assign({encoderApplication:2049,encoderFrameSize:20,encoderSampleRate:48e3,maxFramesPerPage:40,numberOfChannels:1,originalSampleRate:44100,resampleQuality:3,serial:Math.floor(4294967296*Math.random())},e),this.rawOpus="boolean"==typeof this.config.rawOpus?this.config.rawOpus:/^audio\/opus\b/i.test(this.config.mimeType);var s=!this.rawOpus;this._opus_encoder_create=t._opus_encoder_create,this._opus_encoder_destroy=t._opus_encoder_destroy,this._opus_encoder_ctl=t._opus_encoder_ctl,this._speex_resampler_process_interleaved_float=t._speex_resampler_process_interleaved_float,this._speex_resampler_init=t._speex_resampler_init,this._speex_resampler_destroy=t._speex_resampler_destroy,this._opus_encode_float=t._opus_encode_float,this._free=t._free,this._malloc=t._malloc,this.HEAPU8=t.HEAPU8,this.HEAP32=t.HEAP32,this.HEAPF32=t.HEAPF32,this.pageIndex=0,this.granulePosition=0,this.segmentData=s?new Uint8Array(65025):new Uint8Array(255),this.segmentDataIndex=0,this.segmentTable=s?new Uint8Array(255):null,this.segmentTableIndex=0,this.framesInPage=0,this.encodedData=s?void 0:[],this.encodedDataLength=0,this.isReady=t.isReady,this.isReady||(t.onready=function(){this.isReady=!0,this.onready&&this.onready()}),s&&this.initChecksumTable(),this.initCodec(),this.initResampler(),1===this.config.numberOfChannels&&(this.interleave=function(e){return e[0]})};OggOpusEncoder.prototype.encode=function(e){this.bufferLength||(this.bufferLength=e[0].length,this.interleavedBuffers=new Float32Array(this.bufferLength*this.config.numberOfChannels));for(var t=!this.rawOpus,s=this.interleave(e),n=0,i=t?[]:null,r=t?null:[],a=this.resampler?this.resampleBufferLength:this.encoderBufferLength,h=this.resampler?this.resampleBuffer:this.encoderBuffer;n<s.length;){var o=Math.min(a-this.sampleBufferIndex,s.length-n);if(h.set(s.subarray(n,n+o),this.sampleBufferIndex),n+=o,this.sampleBufferIndex+=o,this.sampleBufferIndex===a){this.resampler&&this._speex_resampler_process_interleaved_float(this.resampler,this.resampleBufferPointer,this.resampleSamplesPerChannelPointer,this.encoderBufferPointer,this.encoderSamplesPerChannelPointer);var l=this._opus_encode_float(this.encoder,this.encoderBufferPointer,this.encoderSamplesPerChannel,this.encoderOutputPointer,this.encoderOutputMaxLength);t?(i.concat(this.segmentPacket(l)),this.framesInPage++,this.framesInPage>=this.config.maxFramesPerPage&&i.push(this.generatePage())):(r.push({page:new Uint8Array(this.encoderOutputBuffer.subarray(0,l))}),this.encodedDataLength+=l),this.sampleBufferIndex=0}}return t?i:r},OggOpusEncoder.prototype.destroy=function(){this.encoder&&(this._free(this.encoderSamplesPerChannelPointer),delete this.encoderSamplesPerChannelPointer,this._free(this.encoderBufferPointer),delete this.encoderBufferPointer,this._free(this.encoderOutputPointer),delete this.encoderOutputPointer,this._opus_encoder_destroy(this.encoder),delete this.encoder,this.resampler&&(this._free(this.resampleSamplesPerChannelPointer),delete this.resampleSamplesPerChannelPointer,this._free(this.resampleBufferPointer),delete this.resampleBufferPointer,this._speex_resampler_destroy(this.resampler),delete this.resampler),this.encodedData&&(this.encodedData=null))},OggOpusEncoder.prototype.flush=function(){var e;return this.framesInPage&&(e=this.generatePage()),this.sampleBufferIndex=0,e},OggOpusEncoder.prototype.encodeFinalFrame=function(){var e=!this.rawOpus,t=e?[]:null;if(this.sampleBufferIndex>0)for(var s=(this.resampleBufferLength-this.sampleBufferIndex)/this.config.numberOfChannels,n=Math.ceil(s/this.bufferLength),i=0;i<n;i++){for(var r=[],a=0;a<this.config.numberOfChannels;a++)r.push(new Float32Array(this.bufferLength));if(!e)return this.encode(r);t.concat(this.encode(r))}if(e)return this.headerType+=4,t.push(this.generatePage()),t},OggOpusEncoder.prototype.getChecksum=function(e){for(var t=0,s=0;s<e.length;s++)t=t<<8^this.checksumTable[t>>>24&255^e[s]];return t>>>0},OggOpusEncoder.prototype.generateCommentPage=function(){var e=new DataView(this.segmentData.buffer);if(e.setUint32(0,1937076303,!0),e.setUint32(4,1936154964,!0),e.setUint32(8,10,!0),e.setUint32(12,1868784978,!0),e.setUint32(16,1919247474,!0),e.setUint16(20,21322,!0),e.setUint32(22,0,!0),!this.rawOpus)return this.segmentTableIndex=1,this.segmentDataIndex=this.segmentTable[0]=26,this.headerType=0,this.generatePage();new Uint8Array(this.segmentData.subarray(0,26));this.encodedDataLength+=26},OggOpusEncoder.prototype.generateIdPage=function(){var e=new DataView(this.segmentData.buffer);if(e.setUint32(0,1937076303,!0),e.setUint32(4,1684104520,!0),e.setUint8(8,1,!0),e.setUint8(9,this.config.numberOfChannels,!0),e.setUint16(10,3840,!0),e.setUint32(12,this.config.originalSampleRateOverride||this.config.originalSampleRate,!0),e.setUint16(16,0,!0),e.setUint8(18,0,!0),!this.rawOpus)return this.segmentTableIndex=1,this.segmentDataIndex=this.segmentTable[0]=19,this.headerType=2,this.generatePage();new Uint8Array(this.segmentData.subarray(0,19));this.encodedDataLength+=19},OggOpusEncoder.prototype.generatePage=function(){var e=this.lastPositiveGranulePosition===this.granulePosition?-1:this.granulePosition,t=new ArrayBuffer(27+this.segmentTableIndex+this.segmentDataIndex),s=new DataView(t),n=new Uint8Array(t);s.setUint32(0,1399285583,!0),s.setUint8(4,0,!0),s.setUint8(5,this.headerType,!0),s.setUint32(6,e,!0),e<0?s.setInt32(10,Math.ceil(e/4294967297)-1,!0):s.setInt32(10,Math.floor(e/4294967296),!0),s.setUint32(14,this.config.serial,!0),s.setUint32(18,this.pageIndex++,!0),s.setUint8(26,this.segmentTableIndex,!0),n.set(this.segmentTable.subarray(0,this.segmentTableIndex),27),n.set(this.segmentData.subarray(0,this.segmentDataIndex),27+this.segmentTableIndex),s.setUint32(22,this.getChecksum(n),!0);var i={message:"page",page:n,samplePosition:this.granulePosition};return this.segmentTableIndex=0,this.segmentDataIndex=0,this.framesInPage=0,e>0&&(this.lastPositiveGranulePosition=e),i},OggOpusEncoder.prototype.initChecksumTable=function(){this.checksumTable=[];for(var e=0;e<256;e++){for(var t=e<<24,s=0;s<8;s++)t=0!=(2147483648&t)?t<<1^79764919:t<<1;this.checksumTable[e]=4294967295&t}},OggOpusEncoder.prototype.setOpusControl=function(e,t){var s=this._malloc(4);this.HEAP32[s>>2]=t,this._opus_encoder_ctl(this.encoder,e,s),this._free(s)},OggOpusEncoder.prototype.initCodec=function(){var e=this._malloc(4);this.encoder=this._opus_encoder_create(this.config.encoderSampleRate,this.config.numberOfChannels,this.config.encoderApplication,e),this._free(e),this.config.encoderBitRate&&this.setOpusControl(4002,this.config.encoderBitRate),this.config.encoderComplexity&&this.setOpusControl(4010,this.config.encoderComplexity),this.encoderSamplesPerChannel=this.config.encoderSampleRate*this.config.encoderFrameSize/1e3,this.encoderSamplesPerChannelPointer=this._malloc(4),this.HEAP32[this.encoderSamplesPerChannelPointer>>2]=this.encoderSamplesPerChannel,this.sampleBufferIndex=0,this.encoderBufferLength=this.encoderSamplesPerChannel*this.config.numberOfChannels,this.encoderBufferPointer=this._malloc(4*this.encoderBufferLength),this.encoderBuffer=this.HEAPF32.subarray(this.encoderBufferPointer>>2,(this.encoderBufferPointer>>2)+this.encoderBufferLength),this.encoderOutputMaxLength=4e3,this.encoderOutputPointer=this._malloc(this.encoderOutputMaxLength),this.encoderOutputBuffer=this.HEAPU8.subarray(this.encoderOutputPointer,this.encoderOutputPointer+this.encoderOutputMaxLength)},OggOpusEncoder.prototype.initResampler=function(){if(this.config.originalSampleRate!==this.config.encoderSampleRate){var e=this._malloc(4);this.resampler=this._speex_resampler_init(this.config.numberOfChannels,this.config.originalSampleRate,this.config.encoderSampleRate,this.config.resampleQuality,e),this._free(e),this.resampleSamplesPerChannel=this.config.originalSampleRate*this.config.encoderFrameSize/1e3,this.resampleSamplesPerChannelPointer=this._malloc(4),this.HEAP32[this.resampleSamplesPerChannelPointer>>2]=this.resampleSamplesPerChannel,this.resampleBufferLength=this.resampleSamplesPerChannel*this.config.numberOfChannels,this.resampleBufferPointer=this._malloc(4*this.resampleBufferLength),this.resampleBuffer=this.HEAPF32.subarray(this.resampleBufferPointer>>2,(this.resampleBufferPointer>>2)+this.resampleBufferLength)}else this.resampler=null},OggOpusEncoder.prototype.interleave=function(e){for(var t=0;t<this.bufferLength;t++)for(var s=0;s<this.config.numberOfChannels;s++)this.interleavedBuffers[t*this.config.numberOfChannels+s]=e[s][t];return this.interleavedBuffers},OggOpusEncoder.prototype.segmentPacket=function(e){for(var t=0,s=[];e>=0;){255===this.segmentTableIndex&&(s.push(this.generatePage()),this.headerType=1);var n=Math.min(e,255);this.segmentTable[this.segmentTableIndex++]=n,this.segmentData.set(this.encoderOutputBuffer.subarray(t,t+n),this.segmentDataIndex),this.segmentDataIndex+=n,t+=n,e-=255}return this.granulePosition+=48*this.config.encoderFrameSize,255===this.segmentTableIndex&&(s.push(this.generatePage()),this.headerType=0),s},"undefined"!=typeof exports?exports.OggOpusEncoder=OggOpusEncoder:"object"==typeof module&&module&&module.exports&&(module.exports.OggOpusEncoder=OggOpusEncoder);
